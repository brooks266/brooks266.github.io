<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>Login - Xposure</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007cba">
    <link rel="stylesheet" href="./css/common.css">
    <meta name="google-adsense-account" content="ca-pub-4923804767674808">
    <style>
        body { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            padding: 40px;
        }
        
        h1 { 
            color: var(--text-primary); 
            margin-bottom: 20px; 
        }
        
        form input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="login-container">
        <h1>Xposure</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('login')">Login</button>
            <button class="tab" onclick="switchTab('signup')">Sign Up</button>
        </div>

        <div id="message" class="message"></div>

        <!-- Login Form -->
        <div id="login-form" class="form-container active">
            <form onsubmit="handleLogin(event)">
                <input type="email" id="login-email" placeholder="Email" required />
                <input type="password" id="login-password" placeholder="Password" required />
                <div class="forgot-password">
                    <a href="#" onclick="showForgotPassword(); return false;">Forgot Password?</a>
                </div>
                <button class="form-button" type="submit">Login</button>
            </form>
            
            <div class="divider"><span>OR</span></div>
            
            <button class="google-btn" onclick="handleGoogleSignIn()">
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
                Sign in with Google
            </button>
        </div>

        <!-- Signup Form -->
        <div id="signup-form" class="form-container">
            <form onsubmit="handleSignup(event)">
                <input type="text" id="signup-name" placeholder="Display Name" required />
                <input type="email" id="signup-email" placeholder="Email" required />
                <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required minlength="6" />
                <input type="password" id="signup-confirm" placeholder="Confirm Password" required />
                <button class="form-button" type="submit">Create Account</button>
            </form>
            
            <div class="divider"><span>OR</span></div>
            
            <button class="google-btn" onclick="handleGoogleSignIn()">
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
                Sign up with Google
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { auth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
                 onAuthStateChanged, googleProvider, signInWithPopup, sendPasswordResetEmail,
                 sendEmailVerification, db, doc, setDoc, getDoc, serverTimestamp } 
        from './js/firebase-config.js';
        
        import { showLoading, showMessage, showSuccess, showError, hideMessage, 
                 getFirebaseErrorMessage } 
        from './js/utils.js';

        // Check if already logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.location.href = './index.html';
            }
        });

        // Switch between login and signup tabs
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('signup-form').classList.add('active');
            }
            hideMessage();
        };

        // Handle Login
        window.handleLogin = async function(e) {
            e.preventDefault();
            hideMessage();
            showLoading(true);

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Check if user profile exists, if not create a minimal one
                const userDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
                
                if (!userDoc.exists()) {
                    // Create minimal user profile if it doesn't exist
                    // User can update their display name in settings
                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        displayName: userCredential.user.email?.split('@')[0] || 'User',
                        email: userCredential.user.email,
                        bio: '',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    });
                    console.log('Created missing user profile during login');
                } else {
                    // Update last login for existing profile
                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        lastLogin: serverTimestamp()
                    }, { merge: true });
                }

                // Redirect handled by onAuthStateChanged
            } catch (error) {
                showLoading(false);
                console.error('Login error:', error);
                const errorMessage = getFirebaseErrorMessage(error, 'login');
                if (errorMessage) {
                    showError(errorMessage);
                }
            }
        };

        // Handle Signup
        window.handleSignup = async function(e) {
            e.preventDefault();
            hideMessage();

            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;

            if (password !== confirm) {
                showMessage('Passwords do not match!', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('Password must be at least 6 characters.', 'error');
                return;
            }

            if (!name) {
                showMessage('Display name is required!', 'error');
                return;
            }

            showLoading(true);

            try {
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log('User account created:', userCredential.user.uid);
                
                // Create user profile in Firestore with the display name from the form
                const profileData = {
                    displayName: name,
                    email: email,
                    bio: '',
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                };
                
                console.log('Creating profile with data:', profileData);
                await setDoc(doc(db, 'users', userCredential.user.uid), profileData);
                console.log('Profile created successfully with displayName:', name);

                // Send email verification
                await sendEmailVerification(userCredential.user);

                showSuccess('Account created! Please check your email to verify.');
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 2000);

            } catch (error) {
                showLoading(false);
                console.error('Signup error:', error);
                const errorMessage = getFirebaseErrorMessage(error, 'signup');
                if (errorMessage) {
                    showError(errorMessage);
                }
            }
        };

        // Handle Google Sign-In
        window.handleGoogleSignIn = async function() {
            hideMessage();
            showLoading(true);

            try {
                const result = await signInWithPopup(auth, googleProvider);
                
                // Check if user profile exists, if not create it
                const userDoc = await getDoc(doc(db, 'users', result.user.uid));
                
                if (!userDoc.exists()) {
                    await setDoc(doc(db, 'users', result.user.uid), {
                        displayName: result.user.displayName || 'User',
                        email: result.user.email,
                        bio: '',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    });
                } else {
                    // Update last login
                    await setDoc(doc(db, 'users', result.user.uid), {
                        lastLogin: serverTimestamp()
                    }, { merge: true });
                }

                // Redirect handled by onAuthStateChanged
            } catch (error) {
                showLoading(false);
                console.error('Google sign-in error:', error);
                const errorMessage = getFirebaseErrorMessage(error, 'google-signin');
                if (errorMessage) {
                    showError(errorMessage);
                }
            }
        };

        // Show forgot password dialog
        window.showForgotPassword = async function() {
            const email = prompt('Enter your email address:');
            
            if (!email) return;

            try {
                await sendPasswordResetEmail(auth, email);
                showSuccess('Password reset email sent! Check your inbox.');
            } catch (error) {
                console.error('Password reset error:', error);
                const errorMessage = getFirebaseErrorMessage(error, 'password-reset');
                if (errorMessage) {
                    showError(errorMessage);
                }
            }
        };
    </script>
</body>

</html>
